- [Введение](#Введение)
- [Разворачивание](#Разворачивание)

## Введение
Пример микросервиса на основе бандла https://github.com/De-Paris07/Event-Bundle

## Разворачивание

Собрать контейнеры
```bash
docker-compose build
```
В /etc/hosts прописать сервер
```bash
127.0.0.1 client.loc
```
Запустить контейнеры
```bash
docker-compose up
```
Установить зависимости
```bash
docker-compose exec php composer install
```
Создать базу
```bash
docker-compose exec php php bin/console doctrine:database:create
```
Накатить миграции
```bash
docker-compose exec php php bin/console doctrine:migrations:migrate
```
Запустить демона
```bash
docker-compose exec php php bin/console event:loop
```
Сделать регистрацию на сервере
Эта команда запускается при деплое. Обновляется состав подписок и роутов
```bash
docker-compose exec php php bin/console event:subscribe
```
Команда удаления сервиса с сервера
```bash
docker-compose exec php php bin/console event:unsubscribe
```

В данном примере поднимается процесс `DaemonPeriodicCommand` в виде демона, который асинхронно отправляет с переодичностью 10 и 15 секунд разные события.
В конфиге задается, что событие `other` для меня критично и сервер должен складывать в другую очередь.
Автоматически под это поднимается консьюмер, процесс поднимается только при поступлении задачи, потом живет в течении 30 секунд, и если нет работы, то умирает.

Процесс `CronCommand` для крона,который раз в минуту запрашивает роут.
Процесс `DispatcherCommand`, который запускается через каждые 30 секунд и отправляет событие.

Консьюмер группа из 2 процессов живущих всегда, и при возникновении большого числа событий будет автоматом масштабироваться максимум до 5 процессов

Все возможности бандла и описание смотреть `https://github.com/De-Paris07/Event-Bundle`

Остальные процессы:
 - query - обработчик роутов
 - healthCheck - собирает статистику по машине(память, проц, количество процессов)
 - retry - проверяет нет ли не отправленных событий и пытается их доставить на сервер
 - socketHandler - сокеты для других микросервисов и сервера.

Каждый процесс можно по-своему сконфигурировать.

